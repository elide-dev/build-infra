name: "Container"

on:
  workflow_call:
    inputs:
      ## Coordinates for the image.
      image:
        description: "Image"
        required: true
        type: string

      ## Tags to apply to the image. If unspecified, standard tags are applied.
      tags:
        description: "Image"
        required: false
        type: string

      ## Registry to push to, prefix to use.
      registry:
        description: "Registry"
        required: false
        default: "ghcr.io"
        type: string

      ## Whether to push the image to GHCR.
      push:
        description: "Push image"
        default: false
        required: false
        type: boolean

      ## Context path for the container build.
      path:
        description: "Context path"
        default: "."
        required: false
        type: string

      ## Dockerfile to build.
      dockerfile:
        description: "Dockerfile"
        required: false
        type: string

      ## Platforms to build for.
      platforms:
        description: "Platforms"
        default: "linux/amd64,linux/arm64"
        required: false
        type: string

      ## Runner machine to use.
      runner:
        description: "Runner"
        required: false
        type: string

      ## Whether to authenticate.
      auth:
        description: "Authenticate"
        required: false
        default: true
        type: boolean

env:
    CONTAINER_REGISTRY: ghcr.io

permissions:
  contents: read

jobs:
  ## Build a container image.
  build-container:
    name: "Build"
    runs-on: ${{ inputs.runner || vars.RUNNER || vars.RUNNER_AMD64 || vars.RUNNER_DEFAULT || 'ubuntu-latest' }}
    permissions:
      contents: "read"
      id-token: "write"
      checks: "write"
      pull-requests: "write"
      packages: "write"
    outputs:
      imageid: ${{ steps.dockerpush.outputs.imageid }}
      digest: ${{ steps.dockerpush.outputs.digest }}
    steps:
        - name: Harden Runner
          uses: step-security/harden-runner@8ca2b8b2ece13480cda6dacd3511b49857a23c09 # v2.5.1
          with:
            egress-policy: audit

        - name: "Setup: Checkout"
          uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        - name: "Setup: QEMU"
          uses: docker/setup-qemu-action@2b82ce82d56a2a04d2637cd93a637ae1b359c0a7 # v2.2.0
          with:
            platforms: "amd64,arm64,arm"
        - name: "Setup: Docker"
          uses: docker/setup-buildx-action@4c0219f9ac95b02789c1075625400b2acbff50b1 # v2.9.1
          id: buildx
          with:
            install: true
        - name: "Setup: GitHub Credentials"
          uses: docker/login-action@a9794064588be971151ec5e7144cb535bcb56e36
          if: inputs.auth
          with:
            registry: ${{ inputs.registry }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}
        - name: "Setup: Image Metadata"
          id: meta
          uses: docker/metadata-action@818d4b7b91585d195f67373fd9cb0332e31a7175 # v4.6.0
          with:
            images: ${{ inputs.registry }}/${{ inputs.image }}
            labels: |
              org.opencontainers.image.vendor=Elide
            tags: |
              type=raw,value=latest,enable={{is_default_branch}}
              type=ref,event=branch
              type=ref,event=tag
              type=ref,event=pr
        - name: "Build: Container"
          uses: docker/build-push-action@2eb1c1961a95fc15694676618e422e8ba1d63825 # v4.1.1
          id: dockerpush
          with:
            push: ${{ inputs.push }}
            tags: ${{ inputs.tags || steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
            platforms: ${{ inputs.platforms }}
            context: ${{ inputs.path }}
            file: ${{ inputs.dockerfile }}
            sbom: true
        - name: "Artifacts: Outputs"
          if: ${{ github.ref == 'refs/heads/main' || (inputs && inputs.push) }}
          run: |
            echo "${{ steps.dockerpush.outputs.imageid }}" > ./image_id
            echo "${{ steps.dockerpush.outputs.digest }}" > ./digest
        - name: "Artifacts: Release"
          uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # v3.1.2
          if: ${{ github.ref == 'refs/heads/main' || (inputs && inputs.push) }}
          with:
            name: release-artifacts
            path: |
              ./image_id
              ./digest
  